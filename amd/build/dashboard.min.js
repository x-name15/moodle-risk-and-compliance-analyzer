/**
 * MRCA Dashboard AMD module.
 *
 * Handles: Chart rendering, pagination, whitelist AJAX, report sending.
 *
 * @module     local_mrca/dashboard
 * @package
 * @copyright  2026 Mr Jacket
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_mrca/dashboard",["jquery"],(function($){return{init:function(chartData,trendData,scanUrl,sesskey){try{if("undefined"!=typeof Chart){var riskCanvas=document.getElementById("mrca-risk-chart");riskCanvas&&chartData&&chartData.labels&&new Chart(riskCanvas,{type:"doughnut",data:{labels:chartData.labels,datasets:[{data:chartData.values,backgroundColor:chartData.colors,borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}});var trendCanvas=document.getElementById("mrca-trend-chart");trendCanvas&&trendData&&trendData.labels&&new Chart(trendCanvas,{type:"line",data:{labels:trendData.labels,datasets:[{label:"Site Risk Index",data:trendData.values,borderColor:"#007bff",backgroundColor:"rgba(0, 123, 255, 0.1)",fill:!0,tension:.3,pointBackgroundColor:"#007bff",pointRadius:5,pointHoverRadius:7}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{min:0,max:100,title:{display:!0,text:"Risk Index"}}},plugins:{legend:{display:!1}}}})}}catch(e){console.warn("MRCA: Chart rendering failed",e)}var paginateTable=function(tableId,pagerId,perPage){var $tbl=$(tableId),$dataRows=$tbl.find("tbody tr").not(".mrca-pii-row"),$piiRows=$tbl.find("tbody tr.mrca-pii-row"),pages=Math.ceil($dataRows.length/perPage),cur=1;if(!($dataRows.length<=perPage)){var show=function(page){$dataRows.hide(),$piiRows.hide(),$dataRows.slice((page-1)*perPage,page*perPage).show(),cur=page,render()},render=function(){var $pg=$(pagerId);if($pg.empty(),!(pages<=1)){var prevDis=1===cur?" disabled":"";$pg.append('<li class="page-item'+prevDis+'"><a class="page-link" href="#" data-page="'+(cur-1)+'">«</a></li>');for(var i=1;i<=pages;i++){var act=i===cur?" active":"";$pg.append('<li class="page-item'+act+'"><a class="page-link" href="#" data-page="'+i+'">'+i+"</a></li>")}var nextDis=cur===pages?" disabled":"";$pg.append('<li class="page-item'+nextDis+'"><a class="page-link" href="#" data-page="'+(cur+1)+'">»</a></li>')}};show(1),$(document).on("click",pagerId+" a.page-link",(function(e){e.preventDefault();var page=parseInt($(this).data("page"),10);page>=1&&page<=pages&&show(page)}))}};paginateTable("#mrca-plugin-table","#mrca-pagination",20),paginateTable("#mrca-dep-table","#mrca-dep-pagination",10),$(document).on("click",".mrca-toggle-pii",(function(e){e.preventDefault(),$($(this).data("target")).toggle(),$(this).find("i").toggleClass("fa-database fa-chevron-up")})),$(document).on("click",".mrca-whitelist-add",(function(){var btn=$(this),comp=btn.data("component"),tbl=btn.data("table"),fld=btn.data("field");btn.prop("disabled",!0).find("i").removeClass("fa-check").addClass("fa-spinner fa-spin"),$.post(scanUrl,{action:"whitelist_add",component:comp,table:tbl,field:fld,sesskey:sesskey}).done((function(response){JSON.parse(response).success?(btn.find("i").removeClass("fa-spinner fa-spin").addClass("fa-check text-success"),btn.closest(".mrca-pii-field").fadeOut(500,(function(){$(this).remove()}))):btn.prop("disabled",!1).find("i").removeClass("fa-spinner fa-spin").addClass("fa-check")})).fail((function(xhr){console.warn("MRCA: Whitelist add failed",xhr.status,xhr.responseText),btn.prop("disabled",!1).find("i").removeClass("fa-spinner fa-spin").addClass("fa-times text-danger")}))})),$(document).on("click",".mrca-whitelist-remove",(function(){var btn=$(this),id=btn.data("id");btn.prop("disabled",!0),$.post(scanUrl,{action:"whitelist_remove",id:id,sesskey:sesskey}).done((function(response){JSON.parse(response).success&&btn.closest(".d-flex").fadeOut(300,(function(){$(this).remove()}))})).fail((function(xhr){console.warn("MRCA: Whitelist remove failed",xhr.status,xhr.responseText),btn.prop("disabled",!1)}))})),$(document).on("click",".mrca-send-report",(function(){var btn=$(this),resultid=btn.data("resultid");btn.prop("disabled",!0).find("i").removeClass("fa-paper-plane").addClass("fa-spinner fa-spin"),$.post(scanUrl,{action:"send_single_report",resultid:resultid,sesskey:sesskey}).done((function(response){var data=JSON.parse(response);btn.find("i").removeClass("fa-spinner fa-spin").addClass("fa-paper-plane"),data.success?(btn.find("i").addClass("text-success"),btn.prop("disabled",!1)):(btn.find("i").addClass("text-danger"),btn.prop("disabled",!1))})).fail((function(xhr){console.warn("MRCA: Send report failed",xhr.status,xhr.responseText),btn.find("i").removeClass("fa-spinner fa-spin").addClass("fa-paper-plane text-danger"),btn.prop("disabled",!1)}))}))}}}));

//# sourceMappingURL=dashboard.min.js.map