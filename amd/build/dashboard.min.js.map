{"version":3,"file":"dashboard.min.js","sources":["../src/dashboard.js"],"sourcesContent":["/* global Chart */\n/**\n * MRCA Dashboard AMD module.\n *\n * Handles: Chart rendering, pagination, whitelist AJAX, report sending.\n *\n * @module     local_mrca/dashboard\n * @package\n * @copyright  2026 Mr Jacket\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n    ['jquery'],\n    function ($) {\n\n        return {\n            /**\n             * Initializes the dashboard.\n             *\n             * @param {Object} chartData Risk distribution chart data.\n             * @param {Object} trendData Risk trend chart data (may be null).\n             * @param {string} scanUrl Base URL for actions.\n             * @param {string} sesskey Session key.\n             */\n            init: function (chartData, trendData, scanUrl, sesskey) {\n\n                // ===== CHARTS =====\n                try {\n                    if (typeof Chart !== 'undefined') {\n                        // Risk Distribution doughnut.\n                        var riskCanvas = document.getElementById('mrca-risk-chart');\n                        if (riskCanvas && chartData && chartData.labels) {\n                            new Chart(riskCanvas, {\n                                type: 'doughnut',\n                                data: {\n                                    labels: chartData.labels,\n                                    datasets: [{\n                                        data: chartData.values,\n                                        backgroundColor: chartData.colors,\n                                        borderWidth: 2,\n                                        borderColor: '#fff'\n                                    }]\n                                },\n                                options: {\n                                    responsive: true,\n                                    maintainAspectRatio: false,\n                                    plugins: {\n                                        legend: { position: 'bottom' }\n                                    }\n                                }\n                            });\n                        }\n\n                        // Risk Trend line chart.\n                        var trendCanvas = document.getElementById('mrca-trend-chart');\n                        if (trendCanvas && trendData && trendData.labels) {\n                            new Chart(trendCanvas, {\n                                type: 'line',\n                                data: {\n                                    labels: trendData.labels,\n                                    datasets: [{\n                                        label: 'Site Risk Index',\n                                        data: trendData.values,\n                                        borderColor: '#007bff',\n                                        backgroundColor: 'rgba(0, 123, 255, 0.1)',\n                                        fill: true,\n                                        tension: 0.3,\n                                        pointBackgroundColor: '#007bff',\n                                        pointRadius: 5,\n                                        pointHoverRadius: 7\n                                    }]\n                                },\n                                options: {\n                                    responsive: true,\n                                    maintainAspectRatio: false,\n                                    scales: {\n                                        y: {\n                                            min: 0,\n                                            max: 100,\n                                            title: { display: true, text: 'Risk Index' }\n                                        }\n                                    },\n                                    plugins: {\n                                        legend: { display: false }\n                                    }\n                                }\n                            });\n                        }\n                    }\n                } catch (e) {\n                    // eslint-disable-next-line no-console\n                    console.warn('MRCA: Chart rendering failed', e);\n                }\n\n                // ===== PAGINATION (reusable) =====\n                // Excludes rows with .mrca-pii-row class from page count.\n                var paginateTable = function (tableId, pagerId, perPage) {\n                    var $tbl = $(tableId);\n                    var $dataRows = $tbl.find('tbody tr').not('.mrca-pii-row');\n                    var $piiRows = $tbl.find('tbody tr.mrca-pii-row');\n                    var pages = Math.ceil($dataRows.length / perPage);\n                    var cur = 1;\n\n                    if ($dataRows.length <= perPage) {\n                        return;\n                    }\n\n                    var show = function (page) {\n                        // Hide all data rows and PII sub-rows.\n                        $dataRows.hide();\n                        $piiRows.hide();\n                        // Show only the current page of data rows.\n                        $dataRows.slice((page - 1) * perPage, page * perPage).show();\n                        cur = page;\n                        render();\n                    };\n\n                    var render = function () {\n                        var $pg = $(pagerId);\n                        $pg.empty();\n\n                        if (pages <= 1) {\n                            return;\n                        }\n\n                        var prevDis = cur === 1 ? ' disabled' : '';\n                        $pg.append('<li class=\"page-item' + prevDis + '\">' +\n                            '<a class=\"page-link\" href=\"#\" data-page=\"' + (cur - 1) + '\">«</a></li>');\n\n                        for (var i = 1; i <= pages; i++) {\n                            var act = i === cur ? ' active' : '';\n                            $pg.append('<li class=\"page-item' + act + '\">' +\n                                '<a class=\"page-link\" href=\"#\" data-page=\"' + i + '\">' + i + '</a></li>');\n                        }\n\n                        var nextDis = cur === pages ? ' disabled' : '';\n                        $pg.append('<li class=\"page-item' + nextDis + '\">' +\n                            '<a class=\"page-link\" href=\"#\" data-page=\"' + (cur + 1) + '\">»</a></li>');\n                    };\n\n                    show(1);\n\n                    $(document).on('click', pagerId + ' a.page-link', function (e) {\n                        e.preventDefault();\n                        var page = parseInt($(this).data('page'), 10);\n                        if (page >= 1 && page <= pages) {\n                            show(page);\n                        }\n                    });\n                };\n\n                // Plugin risk table — 20 per page.\n                paginateTable('#mrca-plugin-table', '#mrca-pagination', 20);\n\n                // Dependency audit table — 10 per page.\n                paginateTable('#mrca-dep-table', '#mrca-dep-pagination', 10);\n\n                // ===== PII FIELD TOGGLE =====\n                $(document).on('click', '.mrca-toggle-pii', function (e) {\n                    e.preventDefault();\n                    var target = $($(this).data('target'));\n                    target.toggle();\n                    // Toggle icon.\n                    var icon = $(this).find('i');\n                    icon.toggleClass('fa-database fa-chevron-up');\n                });\n\n                // ===== WHITELIST ADD =====\n                $(document).on('click', '.mrca-whitelist-add', function () {\n                    var btn = $(this);\n                    var comp = btn.data('component');\n                    var tbl = btn.data('table');\n                    var fld = btn.data('field');\n                    btn.prop('disabled', true).find('i').removeClass('fa-check').addClass('fa-spinner fa-spin');\n                    $.post(scanUrl, {\n                        action: 'whitelist_add',\n                        component: comp,\n                        table: tbl,\n                        field: fld,\n                        sesskey: sesskey\n                    }).done(function (response) {\n                        var data = JSON.parse(response);\n                        if (data.success) {\n                            btn.find('i').removeClass('fa-spinner fa-spin').addClass('fa-check text-success');\n                            btn.closest('.mrca-pii-field').fadeOut(500, function () {\n                                $(this).remove();\n                            });\n                        } else {\n                            btn.prop('disabled', false).find('i').removeClass('fa-spinner fa-spin').addClass('fa-check');\n                        }\n                    }).fail(function (xhr) {\n                        // eslint-disable-next-line no-console\n                        console.warn('MRCA: Whitelist add failed', xhr.status, xhr.responseText);\n                        btn.prop('disabled', false).find('i').removeClass('fa-spinner fa-spin').addClass('fa-times text-danger');\n                    });\n                });\n\n                // ===== WHITELIST REMOVE =====\n                $(document).on('click', '.mrca-whitelist-remove', function () {\n                    var btn = $(this);\n                    var id = btn.data('id');\n                    btn.prop('disabled', true);\n                    $.post(scanUrl, {\n                        action: 'whitelist_remove',\n                        id: id,\n                        sesskey: sesskey\n                    }).done(function (response) {\n                        var data = JSON.parse(response);\n                        if (data.success) {\n                            btn.closest('.d-flex').fadeOut(300, function () {\n                                $(this).remove();\n                            });\n                        }\n                    }).fail(function (xhr) {\n                        // eslint-disable-next-line no-console\n                        console.warn('MRCA: Whitelist remove failed', xhr.status, xhr.responseText);\n                        btn.prop('disabled', false);\n                    });\n                });\n\n                // ===== SEND SINGLE REPORT =====\n                $(document).on('click', '.mrca-send-report', function () {\n                    var btn = $(this);\n                    var resultid = btn.data('resultid');\n                    btn.prop('disabled', true).find('i').removeClass('fa-paper-plane').addClass('fa-spinner fa-spin');\n                    $.post(scanUrl, {\n                        action: 'send_single_report',\n                        resultid: resultid,\n                        sesskey: sesskey\n                    }).done(function (response) {\n                        var data = JSON.parse(response);\n                        btn.find('i').removeClass('fa-spinner fa-spin').addClass('fa-paper-plane');\n                        if (data.success) {\n                            btn.find('i').addClass('text-success');\n                            btn.prop('disabled', false);\n                        } else {\n                            btn.find('i').addClass('text-danger');\n                            btn.prop('disabled', false);\n                        }\n                    }).fail(function (xhr) {\n                        // eslint-disable-next-line no-console\n                        console.warn('MRCA: Send report failed', xhr.status, xhr.responseText);\n                        btn.find('i').removeClass('fa-spinner fa-spin').addClass('fa-paper-plane text-danger');\n                        btn.prop('disabled', false);\n                    });\n                });\n            }\n        };\n    }\n);\n"],"names":["define","$","init","chartData","trendData","scanUrl","sesskey","Chart","riskCanvas","document","getElementById","labels","type","data","datasets","values","backgroundColor","colors","borderWidth","borderColor","options","responsive","maintainAspectRatio","plugins","legend","position","trendCanvas","label","fill","tension","pointBackgroundColor","pointRadius","pointHoverRadius","scales","y","min","max","title","display","text","e","console","warn","paginateTable","tableId","pagerId","perPage","$tbl","$dataRows","find","not","$piiRows","pages","Math","ceil","length","cur","show","page","hide","slice","render","$pg","empty","prevDis","append","i","act","nextDis","on","preventDefault","parseInt","this","toggle","toggleClass","btn","comp","tbl","fld","prop","removeClass","addClass","post","action","component","table","field","done","response","JSON","parse","success","closest","fadeOut","remove","fail","xhr","status","responseText","id","resultid"],"mappings":"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"}